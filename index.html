/***************************
 * Normalizador de texto
 ***************************/
function normalize(s){
  if(!s) return '';
  s = s.normalize('NFKD').replace(/[\u0300-\u036f]/g,''); 
  s = s.toLowerCase();
  s = s.replace(/[^a-z0-9]/g,'');
  return s;
}

/***************************
 * Respuestas aceptadas
 ***************************/
const accepted = {
  1: ['diafragmas','diafragma'],
  2: ['anillo'],
  3: ['pastillas','pastilla'],
  4: ['inyeccion','inyectable'],
  5: ['infeccion'],
  6: ['condon','condom'],
  7: ['calendario'],
  8: ['parche'],
  9: ['sexualidad'],
  10:['espermicida'],
  11:['implante'],
  12:['diu','d i u'],
  13:['vasectomia'],
  14:['pildoras','pildora'],
  15:['abstinencia']
};

// Normalizar
Object.keys(accepted).forEach(k=>{
  accepted[k] = Array.from(new Set(accepted[k].map(normalize)));
});

/***************************
 * Reemplazos finales
 ***************************/
const replacements = {
  1:'D I A F R A G M A S',
  2:'A N I L L O',
  3:'P A S T I L L A S',
  4:'I N Y E C C I O N',
  5:'I N F E C C I O N',
  6:'C O N D O N',
  7:'C A L E N D A R I O',
  8:'P A R C H E',
  9:'S E X U A L I D A D',
  10:'E S P E R M I C I D A',
  11:'I M P L A N T E',
  12:'D I U',
  13:'V A S E C T O M I A',
  14:'P I L D O R A S',
  15:'A B S T I N E N C I A'
};

/***************************
 * Pistas
 ***************************/
const clues = {
1:'dispositivo de silicona con forma de cúpula que se inserta en la vagina',
2:'método anticonceptivo femenino flexible que va dentro de la vagina',
3:'se toman el día después de tener relaciones sexuales, son de emergencia',
4:'método anticonceptivo hormonal que espesa el moco cervical y se aplica cada 3 meses',
5:'cuando ingresa un germen o agente patógeno genera una...',
6:'funda delgada, generalmente de látex que se coloca sobre el pene',
7:'método basado en registrar las fechas de la menstruación y calcular días fértiles',
8:'método de prevención que libera hormonas a través de la piel',
9:'es el modo en que cada persona experimenta el amor, el deseo y el afecto',
10:'sustancia química utilizada que destruye los espermatozoides',
11:'dispositivo chico similar a una varilla flexible que se inserta debajo de la piel',
12:'dispositivo chico de plástico en forma de "T" que se inserta en el útero',
13:'consiste en una cirugía para cortar o bloquear los conductos deferentes masculinos',
14:'se toman todos los días e inhibe la ovulación',
15:'consiste decidir de no tener relaciones sexuales'
};

/***************************
 * Estados iniciales
 ***************************/
const initial = {
  A:'_ _ A _ _ _ _ _ _',
  N:'_ N _ _ _',
  T:'_ _ _ T _ _ _ _ _',
  I1:'I _ _ _ _ _ _ _ _',
  C:'_ _ _ _ C _ _ _ _',
  O:'_ O _ _ _ _',
  N1:'_ _ _ _ N _ _ _ _ _',
  C1:'_ _ _ C _ _',
  E:'_ E _ _ _ _ _ _ _ _',
  P1:'_ _ P _ _ _ _ _ _ _ _',
  T1:'_ _ _ _ _ _ T _',
  I2:'_ I _',
  V:'V _ _ _ _ _ _ _ _ _',
  O1:'_ _ _ _ O _ _ _',
  S:'_ _ S _ _ _ _ _ _ _ _'
};

let state = {...initial, solvedCount:0, surrendered:false};
let stats = {
  attempts:0,
  correct:0,
  incorrect:0,
  startedAt:null,
  perWordAttempts:{}
};

/***************************
 * Elementos del DOM
 ***************************/
const entriesEl = document.getElementById('entries');
const cluesEl = document.getElementById('clues');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const progressFill = document.getElementById('progressFill');

const statAttempts = document.getElementById('statAttempts');
const statCorrect = document.getElementById('statCorrect');
const statIncorrect = document.getElementById('statIncorrect');
const statAccuracy = document.getElementById('statAccuracy');

const modalBack = document.getElementById('modalBack');
const modalNum = document.getElementById('modalNum');
const modalClue = document.getElementById('modalClue');
const answerInput = document.getElementById('answerInput');
const submitAnswer = document.getElementById('submitAnswer');
const cancelBtn = document.getElementById('cancelBtn');
const modalMsg = document.getElementById('modalMsg');

const startBtn = document.getElementById('startBtn');
const rulesBtn = document.getElementById('rulesBtn');
const surrenderBtn = document.getElementById('surrenderBtn');
const resetBtn = document.getElementById('resetBtn');

/***************************
 * Renderizar palabras
 ***************************/
function renderEntries(){
  entriesEl.innerHTML = '';

  const list = [
    {n:1,key:'A'},{n:2,key:'N'},{n:3,key:'T'},{n:4,key:'I1'},
    {n:5,key:'C'},{n:6,key:'O'},{n:7,key:'N1'},{n:8,key:'C1'},
    {n:9,key:'E'},{n:10,key:'P1'},{n:11,key:'T1'},{n:12,key:'I2'},
    {n:13,key:'V'},{n:14,key:'O1'},{n:15,key:'S'}
  ];

  list.forEach(item=>{
    const d = document.createElement('div');
    d.className='entry';
    d.setAttribute('role','button');
    d.tabIndex = 0;

    d.innerHTML = `
      <div class="num">#${item.n}</div>
      <div class="val" id="val-${item.key}">${state[item.key]}</div>
    `;

    d.addEventListener('click', ()=>openModal(item.n));
    d.addEventListener('keydown', e=>{
      if(e.key === 'Enter') openModal(item.n);
    });

    entriesEl.appendChild(d);
  });
}

/***************************
 * Renderizar pistas
 ***************************/
function renderClues(){
  cluesEl.innerHTML='';
  for(let i=1;i<=15;i++){
    const el = document.createElement('div');
    el.className='clue';
    el.textContent = `${i}. ${clues[i]}`;
    cluesEl.appendChild(el);
  }
}

/***************************
 * Estadísticas
 ***************************/
function updateStatsUI(){
  statAttempts.textContent = stats.attempts;
  statCorrect.textContent = stats.correct;
  statIncorrect.textContent = stats.incorrect;

  const acc = stats.attempts ?
    Math.round((stats.correct / stats.attempts)*100) : 0;

  statAccuracy.textContent = acc + '%';

  const pct = Math.round((state.solvedCount / 15)*100);
  progressFill.style.width = pct + '%';
  progressFill.parentElement.setAttribute('aria-valuenow', pct);

  if(state.surrendered)
    statusEl.textContent = 'Te rendiste.';
  else if(state.solvedCount >= 15){
    statusEl.textContent = 'Felicidades, ganaste!';
    statusEl.style.color='var(--success)';
  }
  else
    statusEl.textContent = `Resueltas: ${state.solvedCount} / 15`;
}

/***************************
 * Log
 ***************************/
function log(msg, type){
  const d = document.createElement('div');
  d.textContent = msg;
  if(type==='err') d.style.color='var(--danger)';
  if(type==='ok') d.style.color='var(--success)';
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

/***************************
 * Modal
 ***************************/
let activeNum = null;

function openModal(n){
  if(state.surrendered){
    log('Juego finalizado.');
    return;
  }
  if(state.solvedCount >= 15){
    log('Juego completado.');
    return;
  }

  activeNum = n;
  modalNum.textContent = n;
  modalClue.textContent = clues[n];
  modalMsg.textContent = '';
  answerInput.value = '';

  modalBack.style.display='flex';
  modalBack.setAttribute('aria-hidden','false');

  setTimeout(()=>answerInput.focus(),150);
}

function closeModal(){
  modalBack.style.display='none';
  modalBack.setAttribute('aria-hidden','true');
  activeNum = null;
}

/***************************
 * Procesar respuesta
 ***************************/
function submitModal(){
  if(activeNum === null) return;

  let raw = (answerInput.value||'').trim();
  if(raw.length===0){
    modalMsg.textContent='Escribí una respuesta.';
    modalMsg.className='msg bad';
    return;
  }

  const norm = normalize(raw);

  stats.attempts++;
  stats.perWordAttempts[activeNum] =
    (stats.perWordAttempts[activeNum]||0) + 1;

  const list = accepted[activeNum] || [];

  if(list.includes(norm)){
    // Correcto
    stats.correct++;
    state.solvedCount++;

    const rep = replacements[activeNum];

    // Inserta la palabra resuelta
    const mapKey = [
      null,'A','N','T','I1','C','O','N1','C1',
      'E','P1','T1','I2','V','O1','S'
    ];
    state[mapKey[activeNum]] = rep;

    log(`Correcto (#${activeNum}): ${raw}`, 'ok');

    modalMsg.textContent = 'Correcto ✓';
    modalMsg.className='msg ok';

    updateStatsUI();
    renderEntries();

    setTimeout(()=>closeModal(),650);
  } else {
    stats.incorrect++;
    log(`Incorrecto (#${activeNum}): ${raw}`, 'err');
    modalMsg.textContent='Incorrecto. Probá otra vez.';
    modalMsg.className='msg bad';
    updateStatsUI();
  }
}

/***************************
 * Rendirse
 ***************************/
function doSurrender(){
  if(confirm('¿Seguro que querés rendirte?')){
    state.surrendered = true;
    updateStatsUI();
    log('El usuario se rindió.');
    closeModal();
  }
}

/***************************
 * Reiniciar
 ***************************/
function resetGame(){
  state = {...initial, solvedCount:0, surrendered:false};
  stats = {
    attempts:0,
    correct:0,
    incorrect:0,
    startedAt:Date.now(),
    perWordAttempts:{}
  };

  modalMsg.textContent='';
  logEl.innerHTML='';

  renderEntries();
  renderClues();
  updateStatsUI();
}

/***************************
 * Eventos
 ***************************/
submitAnswer.addEventListener('click', submitModal);
answerInput.addEventListener('keydown', e=>{
  if(e.key==='Enter') submitModal();
});
cancelBtn.addEventListener('click', closeModal);
modalBack.addEventListener('click', e=>{
  if(e.target===modalBack) closeModal();
});

startBtn.addEventListener('click', ()=>{
  if(!stats.startedAt) stats.startedAt = Date.now();
  openModal(1);
});

rulesBtn.addEventListener('click', ()=>{
  alert('Cómo jugar:\n1) Tocá un número.\n2) Escribí la palabra completa.\n3) 16 = Rendirse.');
});

surrenderBtn.addEventListener('click', doSurrender);

resetBtn.addEventListener('click', ()=>{
  if(confirm('¿Reiniciar el juego?')) resetGame();
});

/***************************
 * Inicializar
 ***************************/
resetGame();
log('Juego listo — tocá un número para comenzar.');
